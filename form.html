<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>বই ধার নেওয়ার ফর্ম - PSTU Islamic Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans Bengali', sans-serif;
        }
        .amiri-font {
            font-family: 'Amiri', serif;
        }
        .dropdown {
            position: relative;
        }
        .filter-input {
            padding-right: 2.5rem;
        }
        .clear-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.5rem;
            color: #10B981;
            font-weight: bold;
            display: none;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 100%;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            border-radius: 0.75rem;
            border: 1px solid #d1fae5;
            margin-top: 0.25rem;
            left: 0;
            right: 0;
        }
        .dropdown-content div {
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            color: #374151;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dropdown-content div:hover {
            background-color: #e0f2f1;
            color: #047857;
        }
        .dropdown-content.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
        <h2 class="text-3xl font-extrabold text-center text-green-700 mb-4 amiri-font">PSTU Islamic Library</h2>
        <h3 class="text-2xl font-bold text-center text-gray-800 mb-6">বই ধার নেওয়ার ফর্ম</h3>

        <form id="bookBorrowForm" class="space-y-6">
            <!-- Simple text input for Borrower Name -->
            <div>
                <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">আপনার নাম: <span class="text-red-500">*</span></label>
                <input type="text" id="userName" name="userName" required
                       class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <!-- Simple text input for Borrower Faculty -->
            <div>
                <label for="userFaculty" class="block text-sm font-medium text-gray-700 mb-1">ফ্যাকাল্টি: <span class="text-red-500">*</span></label>
                <input type="text" id="userFaculty" name="userFaculty" required
                       class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <!-- Simple text input for Borrower Session -->
            <div>
                <label for="userSession" class="block text-sm font-medium text-gray-700 mb-1">সেশন: <span class="text-red-500">*</span></label>
                <input type="text" id="userSession" name="userSession" required
                       class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <!-- Simple text input for Borrower Hall -->
            <div>
                <label for="userHall" class="block text-sm font-medium text-gray-700 mb-1">হল: <span class="text-red-500">*</span></label>
                <input type="text" id="userHall" name="userHall" required
                       class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <!-- Simple text input for Borrower Email -->
            <div>
                <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">ইমেইল: <span class="text-red-500">*</span></label>
                <input type="email" id="userEmail" name="userEmail" required
                       class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <!-- Simple text input for Borrower Phone -->
            <div>
                <label for="userPhone" class="block text-sm font-medium text-gray-700 mb-1">ফোন নম্বর: <span class="text-red-500">*</span></label>
                <input type="tel" id="userPhone" name="userPhone" required
                       class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <!-- Book Selection - Autopopulated from in-code data -->
            <div class="dropdown">
                <label for="bookSearch" class="block text-sm font-medium text-gray-700 mb-1">বই নির্বাচন করুন: <span class="text-red-500">*</span></label>
                <div class="relative">
                    <input type="text" id="bookSearch" name="selectedBookTitle" placeholder="বইয়ের নাম বা সিরিয়াল টাইপ করুন..." required
                           class="filter-input w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
                    <span id="bookClearBtn" class="clear-btn">&times;</span>
                </div>
                <div id="bookSuggestions" class="dropdown-content"></div>
                <input type="hidden" id="selectedBookSerial" name="selectedBookSerial">
            </div>

            <!-- Book Owner Email - Now visible -->
            <div>
                <label for="bookOwnerEmail" class="block text-sm font-medium text-gray-700 mb-1">বইয়ের মালিকের ইমেইল:</label>
                <input type="email" id="bookOwnerEmail" name="bookOwnerEmail" readonly
                       class="w-full px-4 py-3 bg-gray-200 border-2 border-green-300 rounded-xl shadow-sm text-gray-600 transition-all duration-200">
            </div>

            <!-- Date input -->
            <div class="mb-6">
                <label for="borrowDate" class="block text-sm font-medium text-gray-700 mb-1">তারিখ: <span class="text-red-500">*</span></label>
                <input type="date" id="borrowDate" name="borrowDate" required
                       class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm font-semibold text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <button type="submit" id="submitButton"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 ease-in-out">
                <span id="buttonText">ফর্ম জমা দিন</span>
                <i id="loadingSpinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
            </button>
            <p id="formStatus" class="mt-4 text-center text-sm font-semibold"></p>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Your Apps Script URL for form submission.
            const appScriptURL = 'https://script.google.com/macros/s/AKfycbxAppE1pGQcMh9_2bNvuacVALqDLPkQhtMJgkRNQjlDXwonCoa66uBt-x_PVUwYeEoh/exec';

            // Variable to hold book data
            let allBooksData = [];

            // Function to fetch book data from the books.json file
            async function fetchBooks() {
                try {
                    const response = await fetch('books.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    allBooksData = await response.json();
                    console.log('Book data loaded successfully:', allBooksData);
                    // Initial display of suggestions on load
                    displaySuggestions(allBooksData);
                } catch (error) {
                    console.error('Failed to load books.json:', error);
                    const errorStatus = document.getElementById('formStatus');
                    errorStatus.textContent = 'বইয়ের ডেটা লোড করতে সমস্যা হয়েছে। নিশ্চিত করুন যে books.json ফাইলটি আছে এবং সার্ভার চলছে।';
                    errorStatus.classList.add('text-red-600');
                }
            }

            // Call the function to fetch data when the script loads
            fetchBooks();

            const form = document.getElementById('bookBorrowForm');
            const bookSearchInput = document.getElementById('bookSearch');
            const bookSuggestionsDiv = document.getElementById('bookSuggestions');
            const bookClearBtn = document.getElementById('bookClearBtn');
            const selectedBookSerialInput = document.getElementById('selectedBookSerial');
            const bookOwnerEmailInput = document.getElementById('bookOwnerEmail');
            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const formStatus = document.getElementById('formStatus');

            // Set the borrow date to today by default
            const today = new Date();
            const formattedDate = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
            document.getElementById('borrowDate').value = formattedDate;

            // Function to display filtered book suggestions
            function displaySuggestions(booksToDisplay) {
                bookSuggestionsDiv.innerHTML = '';
                if (booksToDisplay.length > 0) {
                    booksToDisplay.forEach(book => {
                        const suggestionItem = document.createElement('div');
                        // Serial number has been removed from the dropdown list.
                        suggestionItem.textContent = `${book.title}`;
                        suggestionItem.dataset.book = JSON.stringify(book);

                        suggestionItem.addEventListener('click', () => {
                            const selectedBook = JSON.parse(suggestionItem.dataset.book);
                            bookSearchInput.value = selectedBook.title;
                            selectedBookSerialInput.value = selectedBook.serial;
                            bookOwnerEmailInput.value = selectedBook.owner_email;
                            bookSuggestionsDiv.classList.remove('show');
                            bookSearchInput.setCustomValidity('');
                            bookClearBtn.style.display = 'block';
                        });
                        bookSuggestionsDiv.appendChild(suggestionItem);
                    });
                    bookSuggestionsDiv.classList.add('show');
                } else {
                    const noResult = document.createElement('div');
                    noResult.textContent = 'কোনো বই পাওয়া যায়নি।';
                    noResult.classList.add('text-gray-500', 'text-center', 'py-2');
                    bookSuggestionsDiv.appendChild(noResult);
                    bookSuggestionsDiv.classList.add('show');
                }
            }

            // Event listener for book search input
            bookSearchInput.addEventListener('input', () => {
                const searchTerm = bookSearchInput.value.toLowerCase().trim();
                bookSearchInput.setCustomValidity('');

                if (searchTerm.length === 0) {
                    displaySuggestions(allBooksData);
                    bookClearBtn.style.display = 'none';
                    selectedBookSerialInput.value = '';
                    bookOwnerEmailInput.value = '';
                    bookSearchInput.setCustomValidity('অনুগ্রহ করে একটি বই নির্বাচন করুন।');
                } else {
                    bookClearBtn.style.display = 'block';
                    const filteredBooks = allBooksData.filter(book =>
                        book.title.toLowerCase().includes(searchTerm) ||
                        book.serial.toString().includes(searchTerm)
                    );
                    displaySuggestions(filteredBooks);
                }
            });

            // Event listener for focus on book search input
            bookSearchInput.addEventListener('focus', () => {
                displaySuggestions(allBooksData);
            });

            // Event listener for clear button
            bookClearBtn.addEventListener('click', () => {
                bookSearchInput.value = '';
                bookSearchInput.focus();
                bookSuggestionsDiv.classList.remove('show');
                bookClearBtn.style.display = 'none';
                selectedBookSerialInput.value = '';
                bookOwnerEmailInput.value = '';
                bookSearchInput.setCustomValidity('অনুগ্রহ করে একটি বই নির্বাচন করুন।');
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (event) => {
                if (!bookSearchInput.contains(event.target) && !bookSuggestionsDiv.contains(event.target) && !bookClearBtn.contains(event.target)) {
                    bookSuggestionsDiv.classList.remove('show');
                    if (bookSearchInput.value.trim() !== '' && selectedBookSerialInput.value === '') {
                        bookSearchInput.setCustomValidity('তালিকা থেকে একটি বই নির্বাচন করুন।');
                    }
                }
            });

            // Form submission logic
            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                if (selectedBookSerialInput.value === '') {
                    bookSearchInput.setCustomValidity('অনুগ্রহ করে তালিকা থেকে একটি বই নির্বাচন করুন।');
                    bookSearchInput.reportValidity();
                    return;
                }

                submitButton.disabled = true;
                buttonText.textContent = 'জমা হচ্ছে...';
                loadingSpinner.classList.remove('hidden');
                formStatus.textContent = '';
                formStatus.classList.remove('text-green-600', 'text-red-600');

                const formData = {
                    userName: document.getElementById('userName').value,
                    userFaculty: document.getElementById('userFaculty').value,
                    userSession: document.getElementById('userSession').value,
                    userHall: document.getElementById('userHall').value,
                    userEmail: document.getElementById('userEmail').value,
                    userPhone: document.getElementById('userPhone').value,
                    selectedBookTitle: bookSearchInput.value,
                    selectedBookSerial: selectedBookSerialInput.value,
                    bookOwnerEmail: bookOwnerEmailInput.value,
                    borrowDate: document.getElementById('borrowDate').value,
                };
                
                // Using a POST request to the Apps Script URL
                try {
                    const response = await fetch(`${appScriptURL}?action=borrowBook`, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData),
                    });

                    // We can't check response status with no-cors, so assume success
                    formStatus.textContent = 'আপনার অনুরোধ সফলভাবে জমা হয়েছে!';
                    formStatus.classList.add('text-green-600');
                    form.reset();
                    bookClearBtn.style.display = 'none';
                    selectedBookSerialInput.value = '';
                    bookOwnerEmailInput.value = '';
                } catch (error) {
                    console.error('Error submitting form:', error);
                    formStatus.textContent = 'ফর্ম জমা দিতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।';
                    formStatus.classList.add('text-red-600');
                } finally {
                    submitButton.disabled = false;
                    buttonText.textContent = 'ফর্ম জমা দিন';
                    loadingSpinner.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>
