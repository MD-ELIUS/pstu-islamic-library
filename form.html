<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>বই ধার নেওয়ার ফর্ম - PSTU Islamic Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Bengali', sans-serif;
        }
        .amiri-font {
            font-family: 'Amiri', serif;
        }
        /* Custom styles for the dropdown search */
        .dropdown {
            position: relative;
        }
        .filter-input {
            padding-right: 2.5rem; /* Space for clear button */
        }
        .clear-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.5rem;
            color: #10B981; /* green-500 */
            font-weight: bold;
            display: none; /* Hidden by default, shown by JS */
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 100%;
            max-height: 200px; /* Limit height for scroll */
            overflow-y: auto; /* Enable scrolling */
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 10;
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid #d1fae5; /* green-100 */
            margin-top: 0.25rem;
            left: 0;
            right: 0;
        }
        .dropdown-content div {
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            color: #374151; /* gray-700 */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dropdown-content div:hover {
            background-color: #e0f2f1; /* green-100 */
            color: #047857; /* green-800 */
        }
        .dropdown-content.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl">
        <h2 class="text-3xl font-extrabold text-center text-green-700 mb-4 amiri-font">PSTU Islamic Library</h2>
        <h3 class=" texl-lg font-bold text-center text-gray-800 mb-6">বই ধার নেওয়ার ফর্ম</h3>

        <form id="bookBorrowForm" class="space-y-6">
            <div>
                <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">আপনার নাম:</label>
                <input type="text" id="userName" name="userName" required
                         class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <div>
                <label for="userFaculty" class="block text-sm font-medium text-gray-700 mb-1">ফ্যাকাল্টি:</label>
                <input type="text" id="userFaculty" name="userFaculty" required
                         class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <div>
                <label for="userSession" class="block text-sm font-medium text-gray-700 mb-1">সেশন:</label>
                <input type="text" id="userSession" name="userSession" required
                         class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <div>
                <label for="userHall" class="block text-sm font-medium text-gray-700 mb-1">হল:</label>
                <input type="text" id="userHall" name="userHall" required
                         class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <div>
                <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">ইমেইল:</label>
                <input type="email" id="userEmail" name="userEmail" required
                         class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
            </div>

            <div>
                <label for="userPhone" class="block text-sm font-medium text-gray-700 mb-1">ফোন নম্বর:</label>
                <input type="tel" id="userPhone" name="userPhone" pattern="[0-9]{10,11}" placeholder="যেমন: ০১৭০০০০০০০০" required
                         class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500">
                <p class="mt-1 text-sm text-gray-500">১১-সংখ্যার মোবাইল নম্বর দিন।</p>
            </div>

            <div class="mb-6">
                <label for="bookSearch" class="block text-sm font-medium text-gray-700 mb-1">বই নির্বাচন করুন:</label>
                <div class="dropdown relative">
                    <input
                        type="text"
                        id="bookSearch"
                        name="selectedBookTitle"
                        placeholder="বই সিলেক্ট করুন..."
                        class="filter-input w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm placeholder:text-gray-500 font-semibold placeholder:font-normal text-gray-800 transition-all duration-200 focus:border-green-500"
                        autocomplete="off"
                        required
                    />
                    <div class="clear-btn" onclick="clearBookSearch()">×</div>
                    <div id="bookSuggestions" class="dropdown-content"></div>
                    <input type="hidden" id="selectedBookSerial" name="selectedBookSerial">
                </div>
            </div>

            <div>
                <label for="bookOwnerEmail" class="block text-sm font-medium text-gray-700 mb-1">বইয়ের মালিকের ইমেইল:</label>
                <input type="email" id="bookOwnerEmail" name="bookOwnerEmail" readonly
                         class="w-full px-4 py-3 border-2 border-green-300 rounded-xl outline-none shadow-sm bg-gray-50 text-gray-600 cursor-not-allowed">
                <p id="bookOwnerEmailDisplay" class="mt-2 text-sm text-gray-600 bg-gray-100 p-2 rounded-md hidden"></p>
            </div>

            <button type="submit"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 ease-in-out">
                ফর্ম জমা দিন
            </button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const bookSearchInput = document.getElementById('bookSearch');
            const bookSuggestionsDiv = document.getElementById('bookSuggestions');
            const clearBtn = document.querySelector('.clear-btn');
            const selectedBookSerialInput = document.getElementById('selectedBookSerial');
            const bookOwnerEmailInput = document.getElementById('bookOwnerEmail');
            const bookOwnerEmailDisplay = document.getElementById('bookOwnerEmailDisplay');
            let allBooksData = []; // Store all books
            let selectedBook = null; // Store the selected book object

            // Function to clear search and selection
            window.clearBookSearch = () => {
                bookSearchInput.value = '';
                bookSuggestionsDiv.innerHTML = '';
                bookSuggestionsDiv.classList.remove('show');
                clearBtn.style.display = 'none';
                selectedBook = null;
                selectedBookSerialInput.value = ''; // Clear selected book serial
                bookOwnerEmailInput.value = '';
                bookOwnerEmailDisplay.textContent = '';
                bookOwnerEmailDisplay.classList.add('hidden');
                bookSearchInput.setCustomValidity('অনুগ্রহ করে একটি বই নির্বাচন করুন।'); // Re-apply validation
            };

            // Function to display suggestions
            const displaySuggestions = (booksToDisplay) => {
                bookSuggestionsDiv.innerHTML = ''; // Clear previous suggestions
                if (booksToDisplay.length > 0) {
                    booksToDisplay.forEach(book => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.textContent = book.title; // Show only the book title
                        suggestionItem.dataset.book = JSON.stringify(book);

                        suggestionItem.addEventListener('click', () => {
                            selectedBook = JSON.parse(suggestionItem.dataset.book);
                            bookSearchInput.value = selectedBook.title;
                            selectedBookSerialInput.value = selectedBook.serial;
                            bookOwnerEmailInput.value = selectedBook.owner_email;
                            bookOwnerEmailDisplay.textContent = `মালিকের ইমেইল: ${selectedBook.owner_email}`;
                            bookOwnerEmailDisplay.classList.remove('hidden');
                            bookSuggestionsDiv.classList.remove('show');
                            bookSearchInput.setCustomValidity(''); // Clear validation on selection
                        });
                        bookSuggestionsDiv.appendChild(suggestionItem);
                    });
                    bookSuggestionsDiv.classList.add('show');
                } else {
                    const noResult = document.createElement('div');
                    noResult.textContent = 'কোনো বই পাওয়া যায়নি।';
                    noResult.classList.add('text-gray-500', 'italic');
                    bookSuggestionsDiv.appendChild(noResult);
                    bookSuggestionsDiv.classList.add('show');
                    selectedBook = null;
                    selectedBookSerialInput.value = ''; // No book found, clear serial
                    bookSearchInput.setCustomValidity('নির্বাচিত বই পাওয়া যায়নি।'); // Show validation for no match
                }
            };


            // Fetch books.json
            fetch('books.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status} - Could not load books.json. Make sure it's in the same directory and accessible.`);
                    }
                    return response.json();
                })
                .then(data => {
                    allBooksData = data;
                    console.log('books.json loaded successfully:', allBooksData);
                    // Initially set custom validity for required input
                    bookSearchInput.setCustomValidity('অনুগ্রহ করে একটি বই নির্বাচন করুন।');
                })
                .catch(error => {
                    console.error('Error loading books.json:', error);
                    bookSearchInput.placeholder = 'বই লোড করা যায়নি।';
                    bookSearchInput.disabled = true;
                    bookSearchInput.setCustomValidity('বই লোড করা যায়নি।'); // Indicate load failure
                });

            // Handle input in search field
            bookSearchInput.addEventListener('input', () => {
                const searchTerm = bookSearchInput.value.toLowerCase().trim();
                bookSearchInput.setCustomValidity(''); // Clear validation message when user starts typing

                if (searchTerm.length === 0) {
                    // If input is empty, show all books
                    displaySuggestions(allBooksData);
                    clearBtn.style.display = 'none';
                    selectedBook = null;
                    selectedBookSerialInput.value = '';
                    bookOwnerEmailInput.value = '';
                    bookOwnerEmailDisplay.textContent = '';
                    bookOwnerEmailDisplay.classList.add('hidden');
                    bookSearchInput.setCustomValidity('অনুগ্রহ করে একটি বই নির্বাচন করুন।'); // Re-apply validation
                } else {
                    clearBtn.style.display = 'block';
                    const filteredBooks = allBooksData.filter(book =>
                        book.title.toLowerCase().includes(searchTerm) ||
                        book.serial.toString().includes(searchTerm)
                    );
                    displaySuggestions(filteredBooks);
                }
            });

            // Show all books when input is focused (clicked)
            bookSearchInput.addEventListener('focus', () => {
                // Only show all books if the input is currently empty or nothing is selected
                if (bookSearchInput.value.trim() === '' || !selectedBook) {
                    displaySuggestions(allBooksData);
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (event) => {
                if (!bookSearchInput.contains(event.target) && !bookSuggestionsDiv.contains(event.target)) {
                    bookSuggestionsDiv.classList.remove('show');
                    // If no book was selected and input still has text, consider it invalid
                    if (!selectedBook && bookSearchInput.value.trim() !== '') {
                        bookSearchInput.setCustomValidity('তালিকা থেকে একটি বই নির্বাচন করুন।');
                    }
                }
            });

            // Form submission handler
            document.getElementById('bookBorrowForm').addEventListener('submit', (event) => {
                event.preventDefault();

                // Final validation before submission
                if (!selectedBook) { // Check if a book has been selected
                    bookSearchInput.setCustomValidity('অনুগ্রহ করে তালিকা থেকে একটি বই নির্বাচন করুন।');
                    bookSearchInput.reportValidity(); // Show validation message
                    return; // Prevent form submission
                }

                const formData = {
                    userName: document.getElementById('userName').value,
                    userFaculty: document.getElementById('userFaculty').value,
                    userSession: document.getElementById('userSession').value,
                    userHall: document.getElementById('userHall').value,
                    userEmail: document.getElementById('userEmail').value,
                    userPhone: document.getElementById('userPhone').value,
                    selectedBookSerial: selectedBook.serial,
                    selectedBookTitle: selectedBook.title,
                    bookOwnerEmail: selectedBook.owner_email,
                    borrowDate: new Date().toISOString().slice(0, 10)
                };

                console.log('ফর্ম ডেটা:', formData);
                alert('ফর্ম সফলভাবে জমা হয়েছে! (এটি একটি ডেমো। আসল ডেটা জমা হবে না।)');

                // *** এখানে আপনার Google Apps Script ওয়েব অ্যাপে ডেটা পাঠানোর কোড যোগ করুন ***
                */
                const appScriptURL = 'আপনার_Google_Apps_Script_Deploy_করা_URL_এখানে_দিন';
                fetch(appScriptURL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                })
                .then(() => {
                    alert('আপনার অনুরোধ সফলভাবে পাঠানো হয়েছে!');
                    document.getElementById('bookBorrowForm').reset();
                    clearBookSearch();
                })
                .catch(error => {
                    console.error('Error submitting form:', error);
                    alert('ফর্ম জমা দিতে সমস্যা হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।');
                });
                */
            });
        });
    </script>
</body>
</html>
